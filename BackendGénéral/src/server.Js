require("dotenv").config();
const http = require("http");
const app = require("./app");
const connecterBaseDeDonnees = require("./config/baseDeDonnees");
const { Server } = require("socket.io");
const initSocket = require("./socket");

const PORT = process.env.PORT || 5000;

// Connexion Ã  la base de donnÃ©es
connecterBaseDeDonnees();

// CrÃ©ation du serveur HTTP
const server = http.createServer(app);

// Liste des origines autorisÃ©es (trÃ¨s important pour le dev local)
const allowedOrigins = [
    "http://localhost:3000",
    "http://localhost:5173",     // Vite (le plus courant)
    "http://localhost:5174",     // Parfois Vite change de port
    "http://127.0.0.1:5173",
    "http://127.0.0.1:3000",
    process.env.FRONTEND_ORIGIN || "http://localhost:5173",
    ];

    // Initialisation de Socket.IO â€“ configuration robuste
    const io = new Server(server, {
    cors: {
        origin: function (origin, callback) {
        // Autorise toutes les origines en dev local
        if (!origin || allowedOrigins.includes(origin)) {
            callback(null, true);
        } else {
            callback(new Error("Not allowed by CORS"));
        }
        },
        methods: ["GET", "POST", "OPTIONS"],
        credentials: true,
        allowedHeaders: ["Content-Type", "Authorization", "my-custom-header"],
    },
    path: "/socket.io/",           // Chemin par dÃ©faut â€“ ne change pas
    transports: ["websocket", "polling"], // websocket en prioritÃ©
    pingTimeout: 60000,            // 60 secondes â€“ Ã©vite les dÃ©connexions prÃ©maturÃ©es
    pingInterval: 25000,
    upgradeTimeout: 30000,         // Temps pour passer en websocket
    });

    // Log dÃ©taillÃ© des connexions (trÃ¨s utile pour debug)
    io.on("connection", (socket) => {
    console.log("ðŸŸ¢ Nouveau client connectÃ© â†’ ID:", socket.id);
    console.log("   â†’ IP:", socket.handshake.address);
    console.log("   â†’ Auth:", socket.handshake.auth);
    console.log("   â†’ Origin:", socket.handshake.headers.origin);

    socket.on("disconnect", (reason) => {
        console.log("ðŸ”´ Client dÃ©connectÃ© â†’ ID:", socket.id, "Raison:", reason);
    });

    // Test ping/pong pour confirmer la connexion bidirectionnelle
    socket.on("ping", () => {
        console.log("Ping reÃ§u de", socket.id);
        socket.emit("pong", { message: "Pong du serveur !" });
    });
    });

    // Rendre io accessible dans les controllers (tu l'utilises dÃ©jÃ )
    app.set("io", io);

    // Initialisation des events socket (ton fichier ./socket)
    initSocket(io);

    // Lancement du serveur
    server.listen(PORT, () => {
    console.log(`ðŸš€ Serveur TAKA TAKA + Socket.IO dÃ©marrÃ© sur http://localhost:${PORT}`);
    console.log(`   â†’ CORS autorisÃ© pour :`, allowedOrigins.join(", "));
});     